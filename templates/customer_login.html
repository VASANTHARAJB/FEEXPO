<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ t('Customer Login') }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="form-card">
    <h1 class="app-title">FARMIO</h1>
    <p class="tagline">{{ t('Connecting Farmers Directly to Consumers') }}</p>

    <form id="customerForm">
        <label for="mobile">{{ t('Mobile Number') }}</label>
        <input type="text" name="mobile" class="form-input" placeholder="{{ t('Enter Mobile Number') }}" required>

        <label for="email">{{ t('Email Address') }}</label>
        <input type="email" name="email" class="form-input" placeholder="{{ t('Enter Email Address') }}" required>

        <button type="submit" class="form-btn">{{ t('Send OTP') }}</button>
    </form>

    <div id="otpSection" style="display:none; margin-top:20px;">
        <label for="otpInput">{{ t('Enter OTP') }}</label>
        <input type="text" id="otpInput" class="form-input" placeholder="{{ t('Enter OTP') }}">

        <button id="verifyOtpBtn" class="form-btn">{{ t('Verify & Login') }}</button>
    </div>

    <div id="message" class="success-msg" style="display:block; text-align:center; margin-top:15px;"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const customerForm = document.getElementById("customerForm");
    const otpSection = document.getElementById("otpSection");
    const message = document.getElementById("message");
    const otpInput = document.getElementById("otpInput");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");

    // SEND OTP
    customerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        message.innerText = "{{ t('Sending OTP...') }}";

        const formData = new FormData(customerForm);
        const response = await fetch("/send_customer_otp", { method:"POST", body:formData });
        const result = await response.json();

        if(result.status === "ok"){
            // üöÄ HACKATHON MAGIC: Translated SMS Alert!
            alert("üì± {{ t('NEW MESSAGE: Your Farmio login OTP is') }} " + result.dummy_otp);

            otpSection.style.display = "block";   // SHOW OTP box
            message.innerText = "{{ t('OTP sent successfully!') }}";
        } else {
            message.innerText = "{{ t('Failed to send OTP!') }}";
        }
    });

    // VERIFY OTP
    verifyOtpBtn.addEventListener("click", async () => {
        const otp = otpInput.value.trim();

        if(otp === ""){
            message.innerText = "{{ t('Please enter OTP') }}";
            return;
        }

        const response = await fetch("/verify_customer_otp", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({otp})
        });

        const result = await response.json();
        message.innerText = result.message;

        // REDIRECT after success
        if(result.status === "ok"){
            window.location.href = result.redirect;
        }
    });
});

function checkDeliveryZone() {
    if (navigator.geolocation) {
        // Get the Consumer's current Live GPS
        navigator.geolocation.getCurrentPosition(function(position) {
            const coords = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };

            // Send to our Flask backend route
            fetch('/check_nearby_farmers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(coords)
            })
            .then(response => response.json())
            .then(data => {
                const display = document.getElementById('green-signal-display');
                if (data.nearby_count > 0) {
                    display.innerHTML = `<div style="padding:15px; background:#d4edda; color:#155724; border-radius:10px;">
                        <strong>‚úÖ {{ t('Green Signal!') }}</strong> {{ t('We found') }} ${data.nearby_count} {{ t('farmers near you.') }} 
                        {{ t('Free delivery is active!') }}
                    </div>`;
                } else {
                    display.innerHTML = `<div style="padding:15px; background:#f8d7da; color:#721c24; border-radius:10px;">
                        <strong>üìç {{ t('Outside Zone.') }}</strong> {{ t('No verified farmers within 5km.') }} 
                        {{ t('Standard delivery rates apply.') }}
                    </div>`;
                }
            });
        });
    } else {
        alert("{{ t('Geolocation is not supported by your browser.') }}");
    }
}
</script>
</body>
</html>